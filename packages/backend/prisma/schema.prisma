// Schema de Prisma para Cervecería USC - Plataforma RPA
// Arquitectura de dominios: Inventario, Reabastecimiento, Aprobaciones, KPIs

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ===== DOMINIO DE USUARIOS Y ROLES =====

// Tabla de Roles del sistema (Admin, Operario, Aprobador, Analista)
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions String   // JSON como String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  users User[]

  @@map("roles")
}

// Tabla de Usuarios
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hash bcrypt
  firstName String
  lastName  String
  isActive  Boolean  @default(true)
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  role                    Role                      @relation(fields: [roleId], references: [id])
  inventoryMovements      MovimientoInventario[]
  solicitudesCreadas      SolicitudCompra[]         @relation("SolicitudCreador")
  aprobacionesAsignadas   SolicitudCompra[]         @relation("AprobadorActual")
  aprobaciones            Aprobacion[]
  importaciones           Importacion[]

  @@map("users")
}

// ===== DOMINIO DE PRODUCTOS E INVENTARIO =====

// Tabla de Proveedores
model Proveedor {
  id        String   @id @default(cuid())
  nombre    String
  contacto  String?
  email     String?
  telefono  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  productos Producto[]

  @@map("proveedores")
}

// Tabla de Productos (entidad principal del dominio)
model Producto {
  id           String   @id @default(cuid())
  sku          String   @unique // SKU único del producto
  nombre       String
  categoria    String   // Categoría del producto
  unidad       String   // Unidad de medida (L, KG, Unidades, etc.)
  proveedorId  String?
  stockActual  Int      @default(0)
  stockMin     Int      @default(0) // Stock mínimo para alertas
  leadTime     Int      @default(7) // Tiempo de entrega en días
  costo        Float
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  proveedor              Proveedor?              @relation(fields: [proveedorId], references: [id])
  movimientos            MovimientoInventario[]
  politicaAbastecimiento PoliticaAbastecimiento?
  solicitudesCompra      SolicitudCompra[]

  @@map("productos")
}

// Tabla de Movimientos de Inventario (eventos de entrada/salida)
model MovimientoInventario {
  id         String   @id @default(cuid())
  productoId String
  tipo       String   // "ENTRADA" | "SALIDA"
  cantidad   Int
  fecha      DateTime @default(now())
  usuarioId  String
  comentario String?
  referencia String?  // Referencia externa (ej: número de solicitud)
  createdAt  DateTime @default(now())

  // Relaciones
  producto Producto @relation(fields: [productoId], references: [id])
  usuario  User     @relation(fields: [usuarioId], references: [id])

  @@map("movimientos_inventario")
}

// ===== DOMINIO DE REABASTECIMIENTO =====

// Tabla de Políticas de Abastecimiento (Strategy Pattern)
model PoliticaAbastecimiento {
  id              String   @id @default(cuid())
  productoId      String   @unique
  estrategia      String   @default("MANUAL") // "EOQ" | "MANUAL"
  rop             Int      @default(0)        // Reorder Point
  stockSeguridad  Int      @default(0)        // Stock de seguridad
  parametrosJSON  String?  // JSON como String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones
  producto Producto @relation(fields: [productoId], references: [id])

  @@map("politicas_abastecimiento")
}

// Tabla de Solicitudes de Compra (Chain of Responsibility)
model SolicitudCompra {
  id                String   @id @default(cuid())
  productoId        String
  cantidad          Int
  estado            String   @default("BORRADOR") // "BORRADOR" | "EN_APROBACION" | etc.
  creadorId         String
  aprobadorActualId String?
  historialJSON     String?  // JSON como String
  fechaCreacion     DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  producto         Producto    @relation(fields: [productoId], references: [id])
  creador          User        @relation("SolicitudCreador", fields: [creadorId], references: [id])
  aprobadorActual  User?       @relation("AprobadorActual", fields: [aprobadorActualId], references: [id])
  aprobaciones     Aprobacion[]

  @@map("solicitudes_compra")
}

// Tabla de Aprobaciones (parte del Chain of Responsibility)
model Aprobacion {
  id           String   @id @default(cuid())
  solicitudId  String
  nivel        Int      // Nivel de aprobación (1, 2, 3...)
  aprobadorId  String
  estado       String   @default("PENDIENTE") // "PENDIENTE" | "APROBADA" | "RECHAZADA"
  comentario   String?
  fecha        DateTime @default(now())

  // Relaciones
  solicitud  SolicitudCompra @relation(fields: [solicitudId], references: [id])
  aprobador  User            @relation(fields: [aprobadorId], references: [id])

  @@map("aprobaciones")
}

// ===== DOMINIO DE KPIs E INDICADORES =====

// Tabla de Indicadores (Observer Pattern para métricas)
model Indicador {
  id           String   @id @default(cuid())
  tipo         String   // "ROTACION_INVENTARIO" | "FILL_RATE" | etc.
  periodo      String   // "2024-10", "2024-Q3", etc.
  valor        Float
  metadataJSON String?  // JSON como String
  fechaCalculo DateTime @default(now())
  createdAt    DateTime @default(now())

  @@map("indicadores")
}

// ===== DOMINIO DE IMPORTACIONES =====

// Tabla de Importaciones (procesamiento de archivos CSV)
model Importacion {
  id           String   @id @default(cuid())
  tipo         String   // "VENTAS" | "STOCK" | "PRODUCTOS"
  estado       String   @default("PENDIENTE") // "PENDIENTE" | "PROCESANDO" | etc.
  archivo      String   // Nombre del archivo
  resumenJSON  String?  // JSON como String
  erroresJSON  String?  // JSON como String
  usuarioId    String
  fechaInicio  DateTime @default(now())
  fechaFin     DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  usuario User @relation(fields: [usuarioId], references: [id])

  @@map("importaciones")
}

// ===== CONSTANTES (Reemplazando enums para SQLite) =====
// RoleName: "ADMIN" | "OPERARIO" | "APROBADOR" | "ANALISTA"
// TipoMovimiento: "ENTRADA" | "SALIDA"
// EstrategiaReposicion: "EOQ" | "MANUAL"
// EstadoSolicitud: "BORRADOR" | "EN_APROBACION" | "APROBADA" | "RECHAZADA" | "CANCELADA"
// EstadoAprobacion: "PENDIENTE" | "APROBADA" | "RECHAZADA"
// TipoIndicador: "ROTACION_INVENTARIO" | "FILL_RATE" | "TIEMPO_CICLO" | "NIVEL_SERVICIO" | "BACKORDERS" | "COSTO_INVENTARIO"
// TipoImportacion: "VENTAS" | "STOCK" | "PRODUCTOS"
// EstadoImportacion: "PENDIENTE" | "PROCESANDO" | "COMPLETADA" | "FALLIDA" | "PARCIAL"

